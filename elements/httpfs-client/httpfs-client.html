<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../httpfs-directory/httpfs-directory.html">
<link rel="import" href="../httpfs-file/httpfs-file.html">
<link rel="import" href="../httpfs-ajax/httpfs-ajax.html">

<polymer-element name="httpfs-client" attributes="hostname port">
    <template>
        <httpfs-ajax
            id="ajax"
            hostname={{hostname}}
            port={{port}}
            resource="stat"
            handleAs="json"
            on-httpfs-response="{{handleStat}}">
        </httpfs-ajax>
        <httpfs-directory
            id="directory"
            hostname={{hostname}}
            port={{port}}
            path={{path}}
            disabled="{{!isDirectory}}">
        </httpfs-directory>
        <httpfs-file
            id="file"
            hostname={{hostname}}
            port={{port}}
            path={{path}}
            disabled="{{isDirectory}}">
        </httpfs-file>
    </template>
    <script>
        Polymer("httpfs-client", {
            isDirectory: true,
            hostname: window.location.hostname,
            port: 9595,
            ready: function () {
                this.setPathFromHref();
                window.onhashchange = this.onhashchange.bind(this);
            },
            setPathFromHref: function () {
                var hash = window.location.hash,
                    hashIndex = hash.indexOf("#");

                if (hashIndex !== 0) {
                    this.path = "/";
                } else {
                    var path = hash.substring(1, hash.length).trim();

                    this.$.ajax.path = path;
                    this.$.ajax.go();
                }
            },
            handleStat: function (event, xhr) {
                var stats = xhr.response,
                    path = stats.path;

                if (stats.isDir && path !== "/") {
                    path += "/";
                }

                this.path = path;
            },
            pathChanged: function (oldPath, path) {
                this.isDirectory = path[path.length - 1] === "/";
            },
            onhashchange: function (event) {
                var newURL = event.newURL,
                    hashIndex = newURL.indexOf("#"),
                    path;

                if (hashIndex < 0) {
                    path = "/";
                } else {
                    path = newURL.substring(hashIndex + 1, newURL.length);
                }

                this.path = path;
            }
        });
    </script>
</polymer-element>
