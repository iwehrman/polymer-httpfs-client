<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../httpfs-directory/httpfs-directory.html">
<link rel="import" href="../httpfs-file/httpfs-file.html">

<polymer-element name="httpfs-client" attributes="host port">
    <template>
        <core-ajax
            id="ajax"
            url="{{url}}/stat" 
            handleAs="json"
            on-core-response="{{handleStat}}">
        </core-ajax>
        <httpfs-directory
            id="directory"
            url="http://{{host}}:{{port}}"
            path={{path}}
            disabled="{{!isDirectory}}">
        </httpfs-directory>
        <httpfs-file
            id="file"
            url="http://{{host}}:{{port}}"
            path={{path}}
            disabled="{{isDirectory}}">
        </httpfs-file>
    </template>
    <script>
        Polymer("httpfs-client", {
            isDirectory: true,
            ready: function () {
                this.host = this.host || window.location.hostname;
                this.port = this.port || "9595";
                this.url = "http://" + this.host + ":" + this.port
                
                this.setPathFromHref();
                window.onhashchange = this.onhashchange.bind(this);
            },
            setPathFromHref: function () {
                var hash = window.location.hash,
                    hashIndex = hash.indexOf("#");

                if (hashIndex !== 0) {
                    this.path = "/";
                } else {
                    var path = hash.substring(1, hash.length).trim();

                    if (path !== "/" && path[path.length - 1] === "/") {
                        path = path.substring(0, path.length - 1);
                    }

                    var encodedPath = path.replace(/ /g, "+");
                    this.$.ajax.params = { path: encodedPath };
                    this.$.ajax.go();
                }
            },
            handleStat: function (event, xhr) {
                var stats = xhr.response,
                    path = stats.path;

                if (stats.isDir && path !== "/") {
                    path += "/";
                }

                this.path = path;
            },
            pathChanged: function (oldPath, path) {
                this.isDirectory = path[path.length - 1] === "/";
            },
            onhashchange: function (event) {
                var newURL = event.newURL,
                    hashIndex = newURL.indexOf("#"),
                    path;

                if (hashIndex < 0) {
                    path = "/";
                } else {
                    path = newURL.substring(hashIndex + 1, newURL.length);
                }

                this.path = path;
            }
        });
    </script>
</polymer-element>
