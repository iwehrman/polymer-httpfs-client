<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../httpfs-url/httpfs-url.html">

<polymer-element name="httpfs-entry" attributes="hostname port path basedir name mtime size directory disabled">
    <template>
        <link rel="stylesheet" href="httpfs-entry.css">

        <httpfs-url id="url"
            hostname={{hostname}}
            port={{port}}
            resource="read"
            preview="true"
        </httpfs-url>

        <div id="preview">
        </div>
        <div id="info">
            <a href='#{{basedir}}{{name}}{{directory ? "/" : ""}}'>{{name}}{{directory ? "/" : ""}}</a> -
            {{mtime}} -
            {{size}}
        </div>
    </template>
    <script>
        var extensionInfo = {
            "jpg": {
                contentType: "image/jpeg",
                image: true
            },
            "jpeg": {
                contentType: "image/jpeg",
                image: true
            },
            "png": {
                contentType: "image/png",
                image: true
            },
            "gif": {
                contentType: "image/gif",
                image: true
            },
            "webp": {
                contentType: "image/webp",
                image: true
            },
            "mp4": {
                contentType: "video/mp4",
                video: true
            },
            "webm": {
                contentType: "video/webm",
                video: true
            }
        };

        var escapePath = function (path) {
            return encodeURIComponent(path)
                .replace(/\%20/g, "+")
                .replace(/[!'()]/g, escape)
                .replace(/\*/g, "%2A");
        };

        Polymer("httpfs-entry", {
            attached: function () {
                this.url = "http://" + this.host;
                if (this.port && this.port !== 80) {
                    this.url += ":80";
                }

                if (!this.disabled) {
                    this.execute();
                }
            },
            disabled: true,
            disabledChanged: function (oldDisabled, disabled) {
                if (!disabled) {
                    this.execute();
                }
            },
            execute: function () {
                if (!this.name || this.directory) {
                    return;
                }

                var dotIndex = this.name.lastIndexOf(".");
                if (dotIndex < 0) {
                    return;
                }

                var extension = this.name.substring(dotIndex + 1, this.name.length);
                extension = extension.trim().toLowerCase();

                var info = extensionInfo[extension];
                if (!info || !info.image) {
                    return;
                }

                var httpfsUrl = this.$.url;
                httpfsUrl.path = this.basedir + this.name;
                httpfsUrl.retina = window.devicePixelRatio === 2;

                var href = httpfsUrl.getUrl(),
                    preview = this.$.preview,
                    imgHtml = "<img src='" + href + "'/>";

                this.$.preview.innerHTML = imgHtml;
            }
        });
    </script>
</polymer-element>
