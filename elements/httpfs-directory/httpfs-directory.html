<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../httpfs-entry/httpfs-entry.html">

<polymer-element name="httpfs-directory" attributes="path url hidden">
    <template>
        <core-ajax
            id="ajax"
            url="{{url}}/readdir" 
            handleAs="json"
            on-core-response="{{handleResponse}}">
        </core-ajax>

        <header>Directory: {{path}}</header>
        <ol id="entries"></ol>
    </template>
    <script>
        Polymer('httpfs-directory', {
            ready: function () {
                if (this.path) {
                    this.execute();
                }
            },
            hidden: false,
            hiddenChanged: function (oldValue, newValue) {
                if (newValue) {
                    this.style.display = "none";
                } else {
                    this.style.display = "";
                }
            },
            pathChanged: function (oldPath, newPath) {
                console.assert(newPath[newPath.length - 1] === "/", "Path must end in /");
                console.log("Path changed to ", newPath);
                this.execute();
            },
            execute: function () {
                var newPath = this.path,
                    trimmedPath = newPath.length > 1 ?
                        newPath.substring(0, newPath.length - 1) : newPath;

                var params = '{"path":"' + trimmedPath + '"}';
                this.$.ajax.setAttribute("params", params);
                this.$.ajax.go();
            },
            handleResponse: function (event, xhr) {
                var entries = xhr.response,
                    basedir = this.path,
                    root = this.$.entries;

                this.$.entries.innerHTML = entries.map(function (entry) {
                    var entryHtml = "<httpfs-entry" +
                        " url='" + this.url + "'" +
                        " basedir='" + basedir + "'" +
                        " name='" + entry.name + "'" +
                        " mtime='" + entry.mtime + "'" +
                        " size='" + entry.size + "'";

                    if (entry.isDir) {
                        entryHtml += "directory='directory'";
                    }

                    entryHtml += "></httpfs-entry>"

                    return "<li>" + entryHtml + "</li>";
                }, this).join("");
            }
        });
    </script>
</polymer-element>
