<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../httpfs-entry/httpfs-entry.html">

<polymer-element name="httpfs-directory" attributes="path url disabled">
    <template>
        <link rel="stylesheet" href="httpfs-directory.css">
        <core-ajax
            id="ajax"
            url="{{url}}/readdir" 
            handleAs="json"
            on-core-response="{{handleResponse}}">
        </core-ajax>

        <header>Directory: {{path}}</header>
        <ol id="entries"></ol>
    </template>
    <script>
        Polymer('httpfs-directory', {
            ready: function () {
                if (this.path && !this.disabled) {
                    this.execute();
                }

                window.onscroll = this.handleScroll.bind(this);
            },
            disabled: false,
            disabledChanged: function (oldValue, newValue) {
                if (newValue) {
                    this.style.display = "none";
                } else {
                    this.style.display = "";
                }
            },
            pathChanged: function (oldPath, newPath) {
                if (!this.disabled) {
                    console.assert(newPath[newPath.length - 1] === "/", "Path must end in /");
                    console.log("Path changed to ", newPath);
                    this.execute();
                }
            },
            execute: function () {
                var newPath = this.path,
                    trimmedPath = newPath.length > 1 ?
                        newPath.substring(0, newPath.length - 1) : newPath,
                    encodedPath = trimmedPath.replace(/ /g, "+");

                var params = { path: encodedPath };
                this.$.ajax.params = params;
                this.$.ajax.go();
            },
            handleResponse: function (event, xhr) {
                var entries = xhr.response,
                    basedir = this.path,
                    root = this.$.entries;

                while (root.lastChild) {
                    root.removeChild(root.lastChild);
                }

                entries.forEach(function (entry) {
                    var fsEntry = document.createElement("httpfs-entry");

                    fsEntry.setAttribute("url", this.url);
                    fsEntry.setAttribute("basedir", basedir);
                    fsEntry.setAttribute("name", entry.name);
                    fsEntry.setAttribute("mtime", entry.mtime);
                    fsEntry.setAttribute("size", entry.size);

                    if (entry.isDir) {
                        fsEntry.setAttribute("directory", "directory");
                    }

                    var li = document.createElement("li");
                    li.appendChild(fsEntry);
                    root.appendChild(li);
                }, this);

                this.showVisibleEntries();
            },
            handleScroll: function (event) {
                requestAnimationFrame(this.showVisibleEntries.bind(this));
            },
            showVisibleEntries: function () {
                var top = window.scrollY,
                    bottom = top + window.screen.height,
                    entries = this.$.entries.children,
                    entry,
                    rect;

                for (var i = entries.length - 1; i >= 0; i--) {
                    entry = entries[i].children[0];
                    rect = entry.getBoundingClientRect();

                    if (rect.bottom < top || rect.top > bottom) {
                        entry.setAttribute("disabled", "true");
                    } else {
                        entry.setAttribute("disabled", "false");
                    }
                }
            }
        });
    </script>
</polymer-element>
